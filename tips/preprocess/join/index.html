<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.4 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <link rel="stylesheet" href="/libs/highlight/github.min.css">
   
  <link rel="stylesheet" href="/css/franklin.css">
<link rel="stylesheet" href="/css/extra.css">
<link rel="stylesheet" href="/css/minimal-mistakes.css">
<link rel="stylesheet" href="/css/adjust.css">
<link rel="stylesheet" href="/css/luminous-basic.min.css">
<link rel="icon" href="/assets/favicon.ico">
<link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/earlyaccess/notosansjp.css" rel="stylesheet">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->

<!--[if IE ]>
<style>
  /* old IE unsupported flexbox fixes */
  .greedy-nav .site-title {
    padding-right: 3em;
  }
  .greedy-nav button {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
  }
</style>
<![endif]-->

   <title>juliaã§å‰å‡¦ç†å¤§å…¨3</title>  
  <!-- end custom head snippets -->
</head>
<body class="layout--single">
  <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hanafsky.com</a>
        <ul class="visible-links">
          <li class="masthead__menu-item"><a href="/tips/" >Julia-tips</a></li>
          <li class="masthead__menu-item"><a href="/blog/" >Blog</a></li>
          <li class="masthead__menu-item"><a href="/project/" >Projects</a></li>
          <li class="masthead__menu-item"><a href="/about/">About</a></li>
        </ul>
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

  <div class="initial-content">
    <div id="main" role="main">
      <div class="sidebar sticky">
        <div itemscope itemtype="https://schema.org/Person">
          <div class="author__avatar">
            <img src="/assets/design/author3.png" alt="Dio" itemprop="image">
          </div>
          <div class="author__content">
            <h3 class="author__name" itemprop="name">Kei Hanafusa</h3>
            <p class="author__bio" itemprop="description">Chemical Engineer, <br> living in Osaka, ğŸ—¾</p>
          </div>
          <div class="author__urls-wrapper">
            <button class="btn btn--inverse">Follow</button>
            <ul class="author__urls social-icons">
              <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
                <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Osaka, Japan</span></li>
              <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
              <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
            </ul>
          </div>

          
          
              

          <div class="author__urls-wrapper">
            <button class="btn btn--inverse">Tag</button>
            <ul class="author__urls social-icons">
              <li>ã‚¿ã‚°</li>
              <li></li>
              <li><a href="/tag/setting/">è¨­å®š</a></li>
              <li><a href="/tag/thirdparty/">ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</a></li>
              <li><a href="/tag/recipe">ãƒ¬ã‚·ãƒ”</a></li>
            </ul>
          </div>
          
        </div>
      </div>


<!-- Content appended here -->
<div class="franklin-content"><h1 id="juliaã§å‰å‡¦ç†å¤§å…¨_4çµåˆ"><a href="#juliaã§å‰å‡¦ç†å¤§å…¨_4çµåˆ" class="header-anchor">juliaã§å‰å‡¦ç†å¤§å…¨ 4.çµåˆ</a></h1>
<p><div class="titleimage"><img src="/assets/tips/preprocess.jpg" alt="" >
<div style="text-align:right; font-size:small; color:grey">(src=https://pixabay.com/photos/food-salad-raw-carrots-1209503/)</div></div> 
<div class="sns-container top">
  <div class="sns-box b-twitter">
    <a href="https://twitter.com/share?url=https://hanafsky.com/tips/preprocess/&text=juliaã§å‰å‡¦ç†å¤§å…¨&via=HanafusaKei&related=HanafusaKei"
    target="_blank" rel="nofollow"><i class="fab fa-twitter"></i></a></div>
  <div class="sns-box b-facebook">
    <a href="http://www.facebook.com/share.php?u=https://hanafsky.com/tips/preprocess/" 
    target="_blank" rel="nofollow"><i class="fab fa-facebook"></i></a></div>
  <div class="sns-box b-hatena">
    <a href="http://b.hatena.ne.jp/add?mode=confirm&url=http://hanafsky.com/tips/preprocess/&title=juliaã§å‰å‡¦ç†å¤§å…¨"
    target="_blank" rel="nofollow"><span class="icon-hatena"></span></a></div>
  <div class="sns-box b-pocket">
    <a href="http://getpocket.com/edit?url=https://hanafsky.com/tips/preprocess/&title=juliaã§å‰å‡¦ç†å¤§å…¨"
    rel="nofollow" target="_blank"><i class="fab fa-get-pocket"></i></a></div>
  <div class="sns-box b-feedly">
    <a href="http://feedly.com/i/subscription/feed/https://hanafsky.com/feed"
    rel="nofollow" target="_blank"><span class="icon-feedly"></i></a></div>
  <div class="sns-box b-line">
    <a href='https://social-plugins.line.me/lineit/share?url=https://hanafsky.com/tips/preprocess/'
    target='blank' rel="nofollow"><span class="icon-line"></span></a></div>
</div>
</p>
<p>juliaã§å‰å‡¦ç†å¤§å…¨ãã®3ã§ã™ã€‚ä»Šå›ã¯çµåˆã‚’æ‰±ã„ã¾ã™ã€‚</p>
<div class="franklin-toc"><ol><li><a href="#æº–å‚™">æº–å‚™</a></li><li><a href="#çµåˆ">çµåˆ</a><ol><li><a href="#ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ">ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ</a></li><li><a href="#æ¡ä»¶ã«å¿œã˜ãŸçµåˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ">æ¡ä»¶ã«å¿œã˜ãŸçµåˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ</a></li><li><a href="#éå»ãƒ‡ãƒ¼ã‚¿ã®çµåˆ">éå»ãƒ‡ãƒ¼ã‚¿ã®çµåˆ</a></li><li><a href="#å…¨çµåˆ">å…¨çµåˆ</a></li></ol></li></ol></div>
<h2 id="æº–å‚™"><a href="#æº–å‚™" class="header-anchor">æº–å‚™</a></h2>
<p>ã¾ãšã¯ã€ãƒ›ãƒ†ãƒ«ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿<code>reserve.csv</code>ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ <code>hotel.csv</code>ã¨<code>customer.csv</code>ã‚‚çµåˆå‡¦ç†ã«åˆ©ç”¨ã™ã‚‹ã®ã§ã€ä¸€ç·’ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚ äºˆç´„æ—¥æ™‚ã®åˆ—ï¼ˆ:reserve_datetimeï¼‰ãŒStringã§èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€DateTimeå‹ã«å¤‰æ›´ã—ã¾ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> DataFrames,CSV,Chain,Downloads,NaturalSort
reserve_url = <span class="hljs-string">&quot;https://raw.githubusercontent.com/hanafsky/awesomebook/master/data/reserve.csv&quot;</span>
hotel_url = <span class="hljs-string">&quot;https://raw.githubusercontent.com/hanafsky/awesomebook/master/data/hotel.csv&quot;</span>
customer_url = <span class="hljs-string">&quot;https://raw.githubusercontent.com/hanafsky/awesomebook/master/data/customer.csv&quot;</span>

reserve_df = <span class="hljs-meta">@chain</span> reserve_url Downloads.download CSV.File DataFrame
hotel_df = <span class="hljs-meta">@chain</span> hotel_url Downloads.download CSV.File DataFrame
customer_df = <span class="hljs-meta">@chain</span> customer_url Downloads.download CSV.File DataFrame
<span class="hljs-keyword">using</span> Dates
reserve_df.reserve_datetime = DateTime.(reserve_df.reserve_datetime, <span class="hljs-string">dateformat&quot;yyyy-mm-dd HH:MM:SS&quot;</span>)
first(hotel_df) |&gt; println</code></pre>
<p><div class="code-output"><pre><code class="plaintext hljs">DataFrameRow
 Row â”‚ hotel_id  base_price  big_area_name  small_area_name  hotel_latitude  hotel_longitude  is_business
     â”‚ String7   Int64       String1        String3          Float64         Float64          Bool
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ h_1            26100  D              D-2                     43.0646          141.511         true
</code></pre></div> <div class="note"><div class="title">ğŸ˜² Note</div>
<div class="content"><p>customer_idã§è‡ªç„¶ãªã‚½ãƒ¼ãƒˆã‚’è¡Œã†ãŸã‚ã«ã€NaturalSort.jlã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚</p>

<a href="https://github.com/JuliaStrings/NaturalSort.jl"><img src="https://github-link-card.s3.ap-northeast-1.amazonaws.com/JuliaStrings/NaturalSort.jl.png" width="460px"></a>

<pre><code class="julia hljs">sort(df,:customer_id,lt=natural)</code></pre>
<p>ã®ã‚ˆã†ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚ æ™®é€šã«ã‚½ãƒ¼ãƒˆã™ã‚‹ã¨ã“ã®ã‚ˆã†ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ãŒã€</p>
<pre><code class="julia hljs">c_1
c_10
c_100</code></pre>
<p>NaturalSort.jlã‚’ä½¿ã†ã¨ã€</p>
<pre><code class="julia hljs">c_1
c_2
c_3</code></pre>
<p>ã®ã‚ˆã†ã«ã€é©åˆ‡ã«ä¸¦ã¹æ›¿ãˆã¦ãã‚Œã¾ã™ã€‚</p></div></div></p>
<h2 id="çµåˆ"><a href="#çµåˆ" class="header-anchor">çµåˆ</a></h2>
<h3 id="ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ"><a href="#ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ" class="header-anchor">ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ</a></h3>
<p><code>reserve_df</code>ã¨<code>hotel_df</code>ã‚’<code>:hotel_id</code>ãŒç­‰ã—ã„ãƒ‡ãƒ¼ã‚¿åŒå£«ã§çµåˆã—ã¾ã™ã€‚ ãŸã ã—ã€å®¿æ³Šäººæ•°ãŒ1ã‹ã¤ãƒ“ã‚¸ãƒã‚¹ãƒ›ãƒ†ãƒ«ã§ã‚ã‚‹ã¨ã„ã†æ¡ä»¶ä»˜ãã§ã™ã€‚</p>
<p>ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ã®ã¯ã€çµåˆå‡¦ç†ã‚’è¡Œã†å‰ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†ã‚’è¡Œã£ã¦ã€ çµåˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚µã‚¤ã‚ºã‚’ãªã‚‹ã¹ãå°ã•ãã™ã‚‹ã“ã¨ã‚‰ã—ã„ã§ã™ã€‚</p>
<p>çµåˆå‡¦ç†ã«ã¯ã€&quot;åŒæ–¹ã«å­˜åœ¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿&quot;åŒå£«ã§ã®çµ±åˆãªã®ã§ã€å†…éƒ¨çµåˆã®é–¢æ•°<code>innerjoin</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ ä»Šå›ã¯ä¸€åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã‚‹ã ã‘ãªã®ã§ã€@chainãƒã‚¯ãƒ­ã«ã‚ˆã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ã¯ä½¿ã£ã¦ã„ã¾ã›ã‚“ã€‚</p>
<pre><code class="julia hljs">innerjoin(filter(:people_num=&gt;==(<span class="hljs-number">1</span>),reserve_df),
          filter(:is_business=&gt;==(<span class="hljs-literal">true</span>),hotel_df),
          on=:hotel_id) |&gt; first |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext hljs">DataFrameRow
 Row â”‚ reserve_id  hotel_id  customer_id  reserve_datetime     checkin_date  checkin_time  checkout_date  people_num  total_price  base_price  big_area_name  small_area_name  hotel_latitude  hotel_longitude  is_business
     â”‚ String7     String7   String7      Dates.DateTime       Dates.Date    Dates.Time    Dates.Date     Int64       Int64        Int64       String1        String3          Float64         Float64          Bool
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ r7          h_256     c_1          2017-12-29T10:38:36  2018-01-25    10:30:00      2018-01-28              1       103500       34500  C              C-1                     38.2373          140.696         true
</code></pre></div>
<h3 id="æ¡ä»¶ã«å¿œã˜ãŸçµåˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ"><a href="#æ¡ä»¶ã«å¿œã˜ãŸçµåˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ" class="header-anchor">æ¡ä»¶ã«å¿œã˜ãŸçµåˆãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆ</a></h3>
<p>ã‚ã‚‹ãƒ›ãƒ†ãƒ«ã¨åŒã˜åœ°åŸŸã«ã‚ã‚‹ãƒ›ãƒ†ãƒ«ã‚’æ¨è–¦ãƒªã‚¹ãƒˆã‚’ä½œã‚‹ä¾‹é¡Œã§ã™ã€‚ è¤‡æ•°ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã¤ãã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ãªã‹ãªã‹è¤‡é›‘ã§ã™ã€‚ å‰å‡¦ç†å¤§å…¨ã¨ã¯é †ç•ªã‚’å¤‰ãˆã¦ã€å…ˆã«ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å€™è£œã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ã¦ãŠãã“ã¨ã«ã—ã¾ã™ã€‚ ã“ã†ã™ã‚‹ã¨ã€ã‚ã¨ã¯1å›ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
<p>è¤‡æ•°åˆ—ã‚’1ã¤ã®åˆ—ã«ã¾ã¨ã‚ã‚‹ä½œæ¥­ã‚’stacké–¢æ•°ã§å®Ÿæ–½ã§ãã¾ã™ã—ã€ã‹ãªã‚ŠAwesomeãªæ›¸ãæ–¹ã ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ãŸã ã—ã€å‡¦ç†ãŒè¤‡é›‘ãªã®ã§ã€ã™ã£ãã‚Šæ›¸ã„ã¦ã‚‚ã‚ã‹ã‚Šã«ãã„ã§ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> Chain
recommend_hotel_mst = <span class="hljs-meta">@chain</span> hotel_df <span class="hljs-keyword">begin</span>
  select(:hotel_id,:big_area_name,:small_area_name)
  stack([:big_area_name,:small_area_name],value_name=:join_area_id)
  select(:hotel_id=&gt;:rec_hotel_id,:join_area_id)
<span class="hljs-keyword">end</span>

base_hotel_mst = <span class="hljs-meta">@chain</span> hotel_df <span class="hljs-keyword">begin</span>
  groupby([:big_area_name,:small_area_name]) <span class="hljs-comment"># big_area,small_areaæ¯ã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</span>
  combine(:hotel_id=&gt;(r-&gt;length(r)-<span class="hljs-number">1</span>)=&gt;:hotel_cnt) <span class="hljs-comment"># hotel_idã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ(è‡ªåˆ†ã‚’ã®ãã)</span>
  transform([:hotel_cnt,:big_area_name,:small_area_name]=&gt;
            ((a,b,c)-&gt;ifelse.(a.&gt;<span class="hljs-number">20</span>,c,b))=&gt;:join_area_id) <span class="hljs-comment"># ã‚«ã‚¦ãƒ³ãƒˆæ•°ãŒ20ä»¥ä¸‹ãªã‚‰big_areaã‚’join_area_idã«è¨­å®š</span>
  select(:small_area_name,:join_area_id) 
  innerjoin(hotel_df,_,on=:small_area_name) <span class="hljs-comment"># hotel_dfã¨:small_area_nameã§å†…éƒ¨çµåˆã™ã‚‹ã€‚</span>
  select(:hotel_id,:join_area_id) 
  innerjoin(_,recommend_hotel_mst, on=:join_area_id) <span class="hljs-comment"># ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å€™è£œã‚’çµåˆã™ã‚‹ã€‚</span>
  filter([:hotel_id,:rec_hotel_id]=&gt;((a,b)-&gt;a .!= b) ,_) <span class="hljs-comment"># è‡ªåˆ†ãƒ›ãƒ†ãƒ«ã‚’ã®ãã</span>
  select(:hotel_id,:rec_hotel_id)
<span class="hljs-keyword">end</span>

first(base_hotel_mst,<span class="hljs-number">10</span>) |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext hljs">10Ã—2 DataFrame
 Row â”‚ hotel_id  rec_hotel_id
     â”‚ String7   String7
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ h_14      h_1
   2 â”‚ h_22      h_1
   3 â”‚ h_27      h_1
   4 â”‚ h_40      h_1
   5 â”‚ h_45      h_1
   6 â”‚ h_77      h_1
   7 â”‚ h_79      h_1
   8 â”‚ h_85      h_1
   9 â”‚ h_91      h_1
  10 â”‚ h_103     h_1
</code></pre></div>
<h3 id="éå»ãƒ‡ãƒ¼ã‚¿ã®çµåˆ"><a href="#éå»ãƒ‡ãƒ¼ã‚¿ã®çµåˆ" class="header-anchor">éå»ãƒ‡ãƒ¼ã‚¿ã®çµåˆ</a></h3>
<h4 id="q_nä»¶å‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—"><a href="#q_nä»¶å‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—" class="header-anchor">Q nä»¶å‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—</a></h4>
<p>2å›å‰ã®äºˆç´„æ™‚ã®æ”¯æ‰•ã„é¡ã‚’ã€æ–°ãŸãªåˆ—ï¼ˆbefore_priceï¼‰ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã¨ã„ã†ä¾‹é¡Œã§ã™ã€‚</p>
<p>ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚</p>
 <div style="text-align:center" class="mermaid"> 
graph TD
  id1(custormer_id,reserve_datetimeã§ä¸¦ã¹æ›¿ãˆ)
  id2(customer_idã«ã¤ã„ã¦groupbyã‚’é©ç”¨)
  id3(lagé–¢æ•°ã‚’ä½¿ã£ã¦2ä»¶å‰ã®æ”¯æ‰•ã„é¡ã‚’èª¿ã¹ã‚‹)
  id1-->id2
  id2-->id3
 </div>
<p>å‰å‡¦ç†å¤§å…¨ã¨é †ç•ªãŒé•ã†ã®ã¯ã€sortã‚’GroupedDataFrameã«å¯¾ã—ã¦ç›´æ¥é©ç”¨ã§ããªã„ã‹ã‚‰ã§ã™ã€‚</p>
<p>ã¾ãšã€lagé–¢æ•°ã‚’ä½¿ã†ãŸã‚ã«ã€ShiftedArrays.jlã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ transformé–¢æ•°ã¯æ–°ãŸãªåˆ—ã‚’ä½œã‚Œã‚‹æ©Ÿèƒ½ãŒselecté–¢æ•°ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€ selecté–¢æ•°ã¨ç•°ãªã‚Šã€é¸æŠã—ã¦ã„ãªã„åˆ—ã‚‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚ GroupedDataFrameã«transformé–¢æ•°ã‚’ä½œç”¨ã•ã›ã‚‹ã¨ã€ãŸã ã®DataFrameå‹ã«æˆ»ã‚‹ã‚ˆã†ã§ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> Chain, ShiftedArrays

<span class="hljs-meta">@chain</span> reserve_df <span class="hljs-keyword">begin</span>
  sort(:reserve_datetime)
  sort(:customer_id,lt=natural)
  groupby(:customer_id)
  transform(:total_price=&gt;(r-&gt;lag(r,<span class="hljs-number">2</span>))=&gt;:before_price)
  select(:customer_id,:reserve_datetime,:total_price,:before_price) <span class="hljs-comment"># è¡¨ç¤ºã™ã‚‹åˆ—ã‚’é¸æŠ</span>
  first(_,<span class="hljs-number">15</span>) <span class="hljs-comment"># 15ä»¶ç›®ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ã§é¸æŠ</span>
  println
<span class="hljs-keyword">end</span></code></pre>
<div class="code-output"><pre><code class="plaintext hljs">UndefVarError: lag not defined
</code></pre></div>
<p>åˆå›ã¨2å›ç›®ã®äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€å‰ã€…å›ã®æ”¯æ‰•é‡‘é¡ãŒmissingã¨ã—ã¦è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚</p>
<h4 id="q_éå»nä»¶ã®åˆè¨ˆå€¤"><a href="#q_éå»nä»¶ã®åˆè¨ˆå€¤" class="header-anchor">Q éå»nä»¶ã®åˆè¨ˆå€¤</a></h4>
<p>ä»Šåº¦ã¯åŒä¸€é¡§å®¢ã®éå»3ä»¶ã®äºˆç´„é‡‘é¡ã®åˆè¨ˆå€¤ã‚’å‡ºåŠ›ã™ã‚‹ä¾‹é¡Œã§ã™ã€‚ Rã®run_sumé–¢æ•°ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã¨ã—ã¦ã¯ã€RollingFunctions.jlãŒä½¿ãˆãã†ã§ã™ã€‚ <code>rolling&#40;f::Function, v::Vector, window::Int64&#41;</code>ã®å½¢å¼ã§å‘¼ã³å‡ºã—ã¦ã¿ã¾ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> RollingFunctions
rolling(sum, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<span class="hljs-number">3</span>)</code></pre><pre><code class="plaintext hljs">3-element Vector{Float64}:
  6.0
  9.0
 12.0</code></pre>
<p>ã‚‚ã¨ã®é…åˆ—ã¨åŒã˜é•·ã•ã§ã€3ã¤æ¯ã«è¶³ã—ãŸå’ŒãŒå¾—ã‚‰ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ ãŸã ã—ã€æœ€åˆã¨2ã¤ç›®ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€3ã¤åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ã‚‰ã€missingã«ç½®ãæ›ãˆãŸã„ã§ã™ã€‚ ã¾ãŸã€ãã‚‚ãã‚‚ãƒ‡ãƒ¼ã‚¿æ•°ãŒçª“å¹…ã‚ˆã‚Šå°‘ãªã„å ´åˆã‚‚missingã‚’è¿”ã—ãŸã„ã§ã™ã­ã€‚</p>
<p>ã“ã®ã‚ˆã†ãªé–¢æ•°ã‚’roll_sumã¨ã—ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">function</span> roll_sum(v,window=<span class="hljs-number">3</span>)
  length(v) &lt; window ? <span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Missing</span>}(<span class="hljs-literal">undef</span>,length(v)) : 
                       vcat(<span class="hljs-built_in">Vector</span>{<span class="hljs-built_in">Missing</span>}(<span class="hljs-literal">undef</span>,window-<span class="hljs-number">1</span>),rolling(sum,v,window))
<span class="hljs-keyword">end</span>
roll_sum([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<span class="hljs-number">3</span>)</code></pre><pre><code class="plaintext hljs">5-element Vector{Union{Missing, Float64}}:
   missing
   missing
  6.0
  9.0
 12.0</code></pre>
<p>å‰ã®ä¾‹ã®lagé–¢æ•°ã‚’roll<em>sumã§ç½®ãæ›ãˆã¦ã€æ–°ãŸã«:price</em>sumã®åˆ—ã‚’ä½œã‚Šã¾ã™ã€‚ DataFrames.jlã§ã¯ã€é©å½“ã«ä½œã£ãŸé–¢æ•°ã‚’ç”¨ã„ã¦ã€ã™ã£ãã‚Šã—ãŸå‡¦ç†ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ <span class="marker"> å¯¾å¿œã™ã‚‹å‡¦ç†ãŒæ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ãªã‘ã‚Œã°ã€ä½œã£ã¦ã—ã¾ãˆã°ã‚ˆã„</span>ã®ã§ã™ã€‚ ã“ã‚Œã¯å‡¦ç†ãŒé«˜é€Ÿãªjuliaãªã‚‰ã§ã¯å¼·ã¿ã ã¨æ€ã„ã¾ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> Chain, ShiftedArrays

<span class="hljs-meta">@chain</span> reserve_df <span class="hljs-keyword">begin</span>
  sort(:reserve_datetime)
  sort(:customer_id,lt=natural)
  groupby(:customer_id)
  transform(:total_price=&gt;roll_sum=&gt;:price_sum)
  select(:customer_id,:reserve_datetime,:total_price,:price_sum) <span class="hljs-comment"># è¡¨ç¤ºã™ã‚‹åˆ—ã‚’é¸æŠ</span>
  first(_,<span class="hljs-number">15</span>) <span class="hljs-comment"># 15ä»¶ç›®ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ã§é¸æŠ</span>
  println
<span class="hljs-keyword">end</span></code></pre>
<div class="code-output"><pre><code class="plaintext hljs">15Ã—4 DataFrame
 Row â”‚ customer_id  reserve_datetime     total_price  price_sum
     â”‚ String7      Dates.DateTime       Int64        Float64?
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ c_1          2016-03-06T13:09:42        97200  missing
   2 â”‚ c_1          2016-07-16T23:39:55        20600  missing
   3 â”‚ c_1          2016-09-24T10:03:17        33600   151400.0
   4 â”‚ c_1          2017-03-08T03:20:10       194400   248600.0
   5 â”‚ c_1          2017-09-05T19:50:37        68100   296100.0
   6 â”‚ c_1          2017-11-27T18:47:05        36000   298500.0
   7 â”‚ c_1          2017-12-29T10:38:36       103500   207600.0
   8 â”‚ c_1          2018-05-26T08:42:51         6000   145500.0
   9 â”‚ c_2          2016-03-05T13:31:06        68400  missing
  10 â”‚ c_2          2016-06-25T09:12:22       320400  missing
  11 â”‚ c_2          2016-11-19T12:49:10        29700   418500.0
  12 â”‚ c_2          2017-05-24T10:06:21        81600   431700.0
  13 â”‚ c_2          2017-10-19T03:03:30       137000   248300.0
  14 â”‚ c_2          2018-02-18T05:12:58        75600   294200.0
  15 â”‚ c_2          2018-04-19T11:25:00        68800   281400.0
</code></pre></div>
<h4 id="q_éå»nä»¶ã®å¹³å‡å€¤"><a href="#q_éå»nä»¶ã®å¹³å‡å€¤" class="header-anchor">Q éå»nä»¶ã®å¹³å‡å€¤</a></h4>
<p>ã“ã®ä¾‹é¡Œã§ã¯ã€</p>
<p>å¹³å‡å€¤ã‚’å‡ºã™é–¢æ•°ã¨ã—ã¦ã¯ã€runmeané–¢æ•°ãŒä½¿ãˆãã†ã§ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> RollingFunctions
runmean([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<span class="hljs-number">3</span>)</code></pre><pre><code class="plaintext hljs">5-element Vector{Float64}:
 1.0
 1.5
 2.0
 3.0
 4.0</code></pre>
<p>ãŸã ã—ã€è‡ªèº«ã®è¡Œã‚’å«ã‚ãªã„å¹³å‡äºˆç´„é‡‘é¡ã§ã‚ã‚Šã€ éå»ã«äºˆç´„ãŒãªã„å ´åˆã¯missingã‚’å‰²ã‚Šå½“ã¦ãŸã„ã®ã§ã€ ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">function</span> price_avg(v,window=<span class="hljs-number">3</span>)
  length(v) &lt; window ? vcat(<span class="hljs-literal">missing</span>,runmean(v,length(v))[<span class="hljs-keyword">begin</span>:<span class="hljs-keyword">end</span>-<span class="hljs-number">1</span>]) :
                       vcat(<span class="hljs-literal">missing</span>,runmean(v,window)[<span class="hljs-keyword">begin</span>:<span class="hljs-keyword">end</span>-<span class="hljs-number">1</span>])
<span class="hljs-keyword">end</span>
price_avg([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>],<span class="hljs-number">3</span>)</code></pre><pre><code class="plaintext hljs">5-element Vector{Union{Missing, Float64}}:
  missing
 1.0
 1.5
 2.0
 3.0</code></pre>
<p>ã†ã¾ãå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> Chain, ShiftedArrays

<span class="hljs-meta">@chain</span> reserve_df <span class="hljs-keyword">begin</span>
  sort(:reserve_datetime)
  sort(:customer_id,lt=natural)
  groupby(:customer_id)
  transform(:total_price=&gt;price_avg=&gt;:price_avg)
  select(:customer_id,:reserve_datetime,:total_price,:price_avg) <span class="hljs-comment"># è¡¨ç¤ºã™ã‚‹åˆ—ã‚’é¸æŠ</span>
  first(_,<span class="hljs-number">15</span>) <span class="hljs-comment"># 15ä»¶ç›®ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ã§é¸æŠ</span>
  println
<span class="hljs-keyword">end</span></code></pre>
<div class="code-output"><pre><code class="plaintext hljs">15Ã—4 DataFrame
 Row â”‚ customer_id  reserve_datetime     total_price  price_avg
     â”‚ String7      Dates.DateTime       Int64        Float64?
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ c_1          2016-03-06T13:09:42        97200  missing
   2 â”‚ c_1          2016-07-16T23:39:55        20600    97200.0
   3 â”‚ c_1          2016-09-24T10:03:17        33600    58900.0
   4 â”‚ c_1          2017-03-08T03:20:10       194400    50466.7
   5 â”‚ c_1          2017-09-05T19:50:37        68100    82866.7
   6 â”‚ c_1          2017-11-27T18:47:05        36000    98700.0
   7 â”‚ c_1          2017-12-29T10:38:36       103500    99500.0
   8 â”‚ c_1          2018-05-26T08:42:51         6000    69200.0
   9 â”‚ c_2          2016-03-05T13:31:06        68400  missing
  10 â”‚ c_2          2016-06-25T09:12:22       320400    68400.0
  11 â”‚ c_2          2016-11-19T12:49:10        29700   194400.0
  12 â”‚ c_2          2017-05-24T10:06:21        81600   139500.0
  13 â”‚ c_2          2017-10-19T03:03:30       137000   143900.0
  14 â”‚ c_2          2018-02-18T05:12:58        75600    82766.7
  15 â”‚ c_2          2018-04-19T11:25:00        68800    98066.7
</code></pre></div>
<h4 id="q_éå»næ—¥ã®åˆè¨ˆå€¤"><a href="#q_éå»næ—¥ã®åˆè¨ˆå€¤" class="header-anchor">Q éå»næ—¥ã®åˆè¨ˆå€¤</a></h4>
<p>äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿è¡Œã«ãŸã„ã—ã¦ã€è‡ªèº«ã®è¡Œã‚’å«ã‚ãšã«åŒã˜é¡§å®¢ã®éå»90æ—¥é–“ã®åˆè¨ˆäºˆç´„é‡‘é¡ã‚’ä»˜ä¸ã™ã‚‹ã¨ã„ã†å•é¡Œã§ã™ã€‚ &#40;äºˆç´„ãŒãªã„å ´åˆã¯0&#41; å•é¡Œã‚‚ã ã‚“ã ã‚“é›£ã—ããªã£ã¦ãã¦ãŠã‚Šã€Rã«ã‚‚pythonã‚‚Awesomeãªå›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
<p>é¡§å®¢ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã®ã¯å‰ã®å•é¡Œã¨å…±é€šã—ã¦ã„ã¾ã™ã®ã§ã€éå»ã®äºˆç´„åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°<code>total_price_history</code>ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ å„äºˆç´„æ—¥æ¯ã«è‡ªèº«ã®è¡Œã‚’å«ã‚ãšã€éå»90æ—¥åˆ†ã®äºˆç´„æ—¥ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã—ãŸæ—¥ä»˜ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸæ—¥ä»˜ã«å«ã¾ã‚Œã‚‹å ´åˆã«ã¤ã„ã¦ã€äºˆç´„é‡‘é¡ã®åˆè¨ˆã®å’Œã‚’ã¨ã£ã¦ ãŸã ã—ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸåˆ—ãŒç©ºã®å ´åˆã¯ã€0ã‚’è¿”ã™ã“ã¨ã«ã—ã¾ã™ã€‚ &#40;<code>enumerate</code>é–¢æ•°ã‚’å¤šç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨ã‚ã‹ã‚Šã«ãã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚&#41;</p>
<pre><code class="julia hljs"><span class="hljs-keyword">using</span> Dates
<span class="hljs-keyword">function</span> total_price_history(reserve_dates,prices;day=Day(<span class="hljs-number">90</span>))
  tp = similar(prices)
  <span class="hljs-keyword">for</span> (index,date) <span class="hljs-keyword">in</span> enumerate(reserve_dates)
    filtered_date = filter(((d)-&gt;date-day â‰¤ d &lt; date), reserve_dates)
    tp[index] = filtered_date==DateTime[] ? <span class="hljs-number">0</span> :
                sum(prices[i] <span class="hljs-keyword">for</span> (i,d) <span class="hljs-keyword">in</span> enumerate(reserve_dates) <span class="hljs-keyword">if</span> d <span class="hljs-keyword">in</span> filtered_date)
  <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> tp
<span class="hljs-keyword">end</span>

<span class="hljs-meta">@chain</span> reserve_df <span class="hljs-keyword">begin</span>
  sort([:customer_id,:reserve_datetime])
  groupby(:customer_id)
  transform([:reserve_datetime,:total_price]=&gt;total_price_history=&gt;:total_price_90d)
  select(:customer_id,:reserve_datetime,:total_price,:total_price_90d) <span class="hljs-comment"># è¡¨ç¤ºã™ã‚‹åˆ—ã‚’é¸æŠ</span>
  sort(:customer_id,lt=natural)
  first(_,<span class="hljs-number">15</span>) <span class="hljs-comment"># 15ä»¶ç›®ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ã§é¸æŠ</span>
  println
<span class="hljs-keyword">end</span></code></pre>
<div class="code-output"><pre><code class="plaintext hljs">15Ã—4 DataFrame
 Row â”‚ customer_id  reserve_datetime     total_price  total_price_90d
     â”‚ String7      Dates.DateTime       Int64        Int64
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ c_1          2016-03-06T13:09:42        97200                0
   2 â”‚ c_1          2016-07-16T23:39:55        20600                0
   3 â”‚ c_1          2016-09-24T10:03:17        33600            20600
   4 â”‚ c_1          2017-03-08T03:20:10       194400                0
   5 â”‚ c_1          2017-09-05T19:50:37        68100                0
   6 â”‚ c_1          2017-11-27T18:47:05        36000            68100
   7 â”‚ c_1          2017-12-29T10:38:36       103500            36000
   8 â”‚ c_1          2018-05-26T08:42:51         6000                0
   9 â”‚ c_2          2016-03-05T13:31:06        68400                0
  10 â”‚ c_2          2016-06-25T09:12:22       320400                0
  11 â”‚ c_2          2016-11-19T12:49:10        29700                0
  12 â”‚ c_2          2017-05-24T10:06:21        81600                0
  13 â”‚ c_2          2017-10-19T03:03:30       137000                0
  14 â”‚ c_2          2018-02-18T05:12:58        75600                0
  15 â”‚ c_2          2018-04-19T11:25:00        68800            75600
</code></pre></div>
<p>ã“ã®ã‚ˆã†ã«ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰ã®å‡¦ç†ã‚’è‡ªä½œã™ã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã¾ã¨ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚</p>
<h3 id="å…¨çµåˆ"><a href="#å…¨çµåˆ" class="header-anchor">å…¨çµåˆ</a></h3>
<p>é¡§å®¢ã”ã¨ã«2017å¹´1æœˆï½2017å¹´3æœˆã®æœˆé–“åˆ©ç”¨æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹å•é¡Œã§ã™ã€‚ ã“ã‚Œã‚‚å°‘ã€…é ­ã‚’æ‚©ã¾ã›ã¾ã—ãŸã€‚ æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
 <div style="text-align:center" class="mermaid"> 
graph TD
  sub1(å¹´æœˆãƒã‚¹ã‚¿ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ)
  sub2(é¡§å®¢ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦å¹´æœˆãƒã‚¹ã‚¿ãƒ¼ã‚’å…¨çµåˆ)
  id1(äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¿…è¦ãªåˆ—ã‚’æŠ½å‡º<br>customer_id,checkin_date,total_price)
  id2(ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥ã‚’å¹´æœˆãƒã‚¹ã‚¿ãƒ¼ã®å½¢å¼ã«åˆã‚ã›ã‚‹)
  id3(å¹´æœˆãƒã‚¹ã‚¿ãƒ¼ã«å¯¾ã—ã¦çµåˆ<br>chainã®éƒ½åˆä¸Šrightjoin)
  id4(é¡§å®¢IDã¨å¹´æœˆã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘)
  id5(äºˆç´„é‡‘é¡ã‚’åˆè¨ˆ)
  id6(Missingã‚’0ã«ç½®ãæ›ãˆ)
  subgraph å¹´æœˆãƒã‚¹ã‚¿ãƒ¼ã®ä½œæˆ
  sub1-->sub2
  end
  id1-->id2
  id2-->id3
  id3-->id4
  id4-->id5
  id5-->id6
 </div>
<p>ã‚³ãƒ¼ãƒ‰åŒ–ã—ãŸã‚‚ã®ãŒã“ã¡ã‚‰ã§ã™ã€‚</p>
<pre><code class="julia hljs"><span class="hljs-comment"># å¹´æœˆãƒã‚¹ã‚¿ã®ç”Ÿæˆ</span>
month_mst = DataFrame(:year_month=&gt;[Date(<span class="hljs-string">&quot;2017-01-01&quot;</span>)+Month(m) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>:<span class="hljs-number">2</span>]) 
customer_mst = crossjoin(customer_df,month_mst)

summary_result = <span class="hljs-meta">@chain</span> reserve_df <span class="hljs-keyword">begin</span>
  select(:customer_id,
         :checkin_date=&gt;ByRow(r-&gt;Date(Year(r),Month(r)))=&gt;:year_month,
         :total_price)
  <span class="hljs-comment"># customer_mstã«å¯¾ã—ã¦çµåˆã—ãŸã„ã®ã§leftjoinã§ã¯ãªãrightjoinã‚’ä½¿ã†ã€‚</span>
  rightjoin(customer_mst,on=[:customer_id,:year_month]) 
  groupby([:customer_id,:year_month])
  combine(:total_price=&gt;sum=&gt;:price_sum)
  sort(:year_month)
  sort(:customer_id,lt=natural)
<span class="hljs-keyword">end</span>
replace!(summary_result.price_sum,<span class="hljs-literal">missing</span>=&gt;<span class="hljs-number">0</span>)

first(summary_result,<span class="hljs-number">10</span>) |&gt; println</code></pre>
<p><div class="code-output"><pre><code class="plaintext hljs">10Ã—3 DataFrame
 Row â”‚ customer_id  year_month  price_sum
     â”‚ String7      Dates.Date  Int64?
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1 â”‚ c_1          2017-01-01          0
   2 â”‚ c_1          2017-02-01          0
   3 â”‚ c_1          2017-03-01     194400
   4 â”‚ c_2          2017-01-01          0
   5 â”‚ c_2          2017-02-01          0
   6 â”‚ c_2          2017-03-01          0
   7 â”‚ c_3          2017-01-01          0
   8 â”‚ c_3          2017-02-01     390600
   9 â”‚ c_3          2017-03-01      18200
  10 â”‚ c_4          2017-01-01          0
</code></pre></div> æœ¬ã®é€šã‚Šã®ç­”ãˆãŒå¾—ã‚‰ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚</p>
<p>ã“ã®ç« ã®å•é¡Œã¯ã‹ãªã‚Šé›£ã—ã„ãŸã‚ã€å•é¡Œã‚’ç†è§£ã™ã‚‹ã®ã‚‚ã‚³ãƒ¼ãƒ‰ã‚’è€ƒãˆã‚‹ã®ã‚‚ã€ã‹ãªã‚Šéª¨ãŒæŠ˜ã‚Œã¾ã—ãŸã€‚ ã—ã‹ã—ã€è‡ªå‰ã§é–¢æ•°ã‚’ç”¨æ„ã™ã‚‹è€ƒãˆã‚„ã€DataFrames.jlã¨Chain.jlã®ãŠã‹ã’ã§ã€æœ¬ã®ã‚³ãƒ¼ãƒ‰ã«å‹ã‚‹ã¨ã‚‚åŠ£ã‚‰ãªã„éå¸¸ã«<span class="marker"> Awesome</span>ãªå‡¦ç†ãŒã§ããŸã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚  <p style="text-align:right">  ã¤ã¥ã </p> 
<div class="sns-container top">
  <div class="sns-box b-twitter">
    <a href="https://twitter.com/share?url=https://hanafsky.com/tips/preprocess/&text=juliaã§å‰å‡¦ç†å¤§å…¨&via=HanafusaKei&related=HanafusaKei"
    target="_blank" rel="nofollow"><i class="fab fa-twitter"></i></a></div>
  <div class="sns-box b-facebook">
    <a href="http://www.facebook.com/share.php?u=https://hanafsky.com/tips/preprocess/" 
    target="_blank" rel="nofollow"><i class="fab fa-facebook"></i></a></div>
  <div class="sns-box b-hatena">
    <a href="http://b.hatena.ne.jp/add?mode=confirm&url=http://hanafsky.com/tips/preprocess/&title=juliaã§å‰å‡¦ç†å¤§å…¨"
    target="_blank" rel="nofollow"><span class="icon-hatena"></span></a></div>
  <div class="sns-box b-pocket">
    <a href="http://getpocket.com/edit?url=https://hanafsky.com/tips/preprocess/&title=juliaã§å‰å‡¦ç†å¤§å…¨"
    rel="nofollow" target="_blank"><i class="fab fa-get-pocket"></i></a></div>
  <div class="sns-box b-feedly">
    <a href="http://feedly.com/i/subscription/feed/https://hanafsky.com/feed"
    rel="nofollow" target="_blank"><span class="icon-feedly"></i></a></div>
  <div class="sns-box b-line">
    <a href='https://social-plugins.line.me/lineit/share?url=https://hanafsky.com/tips/preprocess/'
    target='blank' rel="nofollow"><span class="icon-line"></span></a></div>
</div>
 
  <div class="prev-next-link">
  <a class="prev-link" href="/tips/preprocess/aggregation">
    <p class="prev-next-label">å‰ã®è¨˜äº‹</p>
    <p>
       juliaã§å‰å‡¦ç†å¤§å…¨ é›†ç´„
    </p>
  </a>
  <a class="next-link" href="/tips/preprocess/split">
    <p class="prev-next-label">æ¬¡ã®è¨˜äº‹</p>
    <p>
       juliaã§å‰å‡¦ç†å¤§å…¨ åˆ†å‰²
    </p>
  </a>
</div>
</p>
 <button onclick="topFunction()" id="myBtn" title="Go to top">Top</button> 
<div class="page-foot">
  <div class="copyright">
    &copy; Kei Hanafusa. Last modified: September 30, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div><!-- CONTENT ENDS HERE -->

      </div> <!-- closure of main -->
    </div>   <!-- closure of class initial--content -->

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
        <!-- end custom footer snippets -->
        <div class="page__footer-follow">
          <ul class="social-icons">
            <li><strong>Follow:</strong></li>
            <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
            <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          </ul>
        </div>
        <div class="page__footer-copyright">&copy; Kei Hanafusa. Powered by <a href="https://github.com/tlienart/Franklin.jl">Franklin</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="/libs/minimal-mistakes/main.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>
    <script src="/libs/myBtn/myBtn.js"></script>
    <script src="/libs/luminous/Luminous.min.js"></script>
    <script src="/libs/clipboard.min.js"></script>

    
    
        


        <!-- http://tutsplus.github.io/clipboard/ -->

<script>
	(function(){
	
		// Get the elements.
		// - the 'pre' element.
		// - the 'div' with the 'paste-content' id.
	
		var pre = document.getElementsByTagName('pre');
	
		// Add a copy button in the 'pre' element.
		// which only has the className of 'language-'.
	
		for (var i = 0; i < pre.length; i++) {
			var isLanguage = pre[i].children[0].className.indexOf('language-');
	
			if ( isLanguage === 0 ) {
				var button           = document.createElement('button');
						button.className = 'copy-button';
						button.textContent = 'Copy';
	
						pre[i].appendChild(button);
			}
		};
	
		// Run Clipboard
	
		var copyCode = new ClipboardJS('.copy-button', {
			target: function(trigger) {
				return trigger.previousElementSibling;
		}
		});
	
		// On success:
		// - Change the "Copy" text to "Copied".
		// - Swap it to "Copy" in 2s.
		// - Lead user to the "contenteditable" area with Velocity scroll.
	
		copyCode.on('success', function(event) {
			event.clearSelection();
			event.trigger.textContent = 'Copied';
			window.setTimeout(function() {
				event.trigger.textContent = 'Copy';
			}, 2000);
	
		});
	
		// On error (Safari):
		// - Change the  "Press Ctrl+C to copy"
		// - Swap it to "Copy" in 2s.
	
		copyCode.on('error', function(event) {
			event.trigger.textContent = 'Press "Ctrl + C" to copy';
			window.setTimeout(function() {
				event.trigger.textContent = 'Copy';
			}, 5000);
		});
	
	})();
	</script>
        <!-- {{ insert foot_copy.html }} -->
    
    
        <script src="/libs/mermaid/mermaid.min.js"></script>
<script>
  var config
  mermaid.initialize({
    theme: 'neutral',
    themeCSS: '\
               .mermaid-main-font {font-family:"Noto Sans JP"};\
               .section0, .section2{fill:#fadbda;opacity:0.3;};\
               .task0, .task1, .task2, .task3 {fill:#fadbda; stroke:#f6bdc0; stroke-width:1};\
               .grid {stroke:#666;stroke-width:0.5};\
               .node rect,\
               .node circle,\
               .node ellipse,\
               .node path,\
               .node polygon\
               {fill:rgba(253,237,228,0.5);\
                stroke: rgb(246,189,192)};\
               .arrowheadPath {fill:rgb(246,189,192);}\
               .edgePath .path {stroke:rgb(246,189,192);};\
               .cluster rect\
               {fill:rgba(255,249,177,0.3);\
                stroke:rgb(246,189,192)};\
               ',
    // themeCSS: '.node rect {fill:rgba(253,237,228,0.5); stroke: rgb(250,219,218)};',
    // logLevel: 3,
    // securityLevel: 'loose',
    // flowchart: { curve: 'basis' }
  });
</script>
    
    <script>
    new LuminousGallery(document.querySelectorAll('.zoom'));
</script>
    <script>
function myToc() {
    var x = document.getElementsByClassName("mytoc");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }
  } 
</script>
  </body>
</html>
