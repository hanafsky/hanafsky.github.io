<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.16.4 by Michael Rose Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE --> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/minimal-mistakes.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="/css/luminous-basic.min.css"> <link rel=icon  href="/assets/favicon.ico"> <!--[if IE ]> <style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; } </style> <![endif]--> <title>Awesome な前処理</title> <body class=layout--single > <div class=masthead > <div class=masthead__inner-wrap > <div class=masthead__menu > <nav id=site-nav  class=greedy-nav > <a class=site-title  href="/">Hanafsky.com</a> <ul class=visible-links > <li class=masthead__menu-item ><a href="/tips/" >Julia-tips</a> <li class=masthead__menu-item ><a href="/blog/" >Blog</a> <li class=masthead__menu-item ><a href="/project/" >Projects</a> <li class=masthead__menu-item ><a href="/about/">About</a> </ul> <button class="greedy-nav__toggle hidden" type=button > <span class=visually-hidden >Toggle menu</span> <div class=navicon ></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class=initial-content > <div id=main  role=main > <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class=author__avatar > <img src="/assets/design/author3.png" alt=Dio  itemprop=image > </div> <div class=author__content > <h3 class=author__name  itemprop=name >Kei Hanafusa</h3> <p class=author__bio  itemprop=description >Chemical Engineer, <br> living in Osaka, 🗾</p> </div> <div class=author__urls-wrapper > <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop=homeLocation  itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden=true ></i> <span itemprop=name >Osaka, Japan</span> <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden=true ></i> Twitter</a> <li><a href="https://github.com/lethal8723" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i> GitHub</a> </ul> </div> <div class=author__urls-wrapper > <button class="btn btn--inverse">Tag</button> <ul class="author__urls social-icons"> <li>タグ <li> <li><a href="/tag/setting/">設定</a> <li><a href="/tag/thirdparty/">サードパーティライブラリ</a> <li><a href="/tag/recipe">レシピ</a> </ul> </div> </div> </div> <div class=franklin-content ><h1 id="awesome_な前処理_2"><a href="#awesome_な前処理_2" class=header-anchor >Awesome な前処理 2</a></h1> <p>前処理大全のjulia版その2です。 まずは、ホテルの予約データを読み込みます。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> DataFrames,CSV
path = joinpath(<span class=hljs-string >&quot;tips&quot;</span>,<span class=hljs-string >&quot;data&quot;</span>,<span class=hljs-string >&quot;reserve.csv&quot;</span>)
reserve_df = CSV.read(path,DataFrame)
<span class=hljs-comment >#first(reserve_df) |&gt; println</span></code></pre> <div class=code-output ><pre><code class="plaintext hljs">ArgumentError: Package CSV not found in current path:
- Run `import Pkg; Pkg.add(&quot;CSV&quot;)` to install the CSV package.

</code></pre></div> <h2><div class=mytoc >目次 <div class=franklin-toc ><ol><li><a href="#3_集約">3 集約</a><ol><li><a href="#3-1_データ数種類数の算出">3-1 データ数、種類数の算出</a><li><a href="#3-2_合計値の算出">3-2 合計値の算出</a><li><a href="#3-3_極値代表値の算出">3-3 極値、代表値の算出</a><li><a href="#3-4_ばらつき具合の算出">3-4 ばらつき具合の算出</a><li><a href="#3-5_最頻値の算出">3-5 最頻値の算出</a><li><a href="#3-6_順位の算出">3-6 順位の算出</a><li><a href="#q_ランキング">Q ランキング</a></ol></ol></div></div></h2> <h2 id="3_集約"><a href="#3_集約" class=header-anchor >3 集約</a></h2> <h3 id="3-1_データ数種類数の算出"><a href="#3-1_データ数種類数の算出" class=header-anchor >3-1 データ数、種類数の算出</a></h3> <p>ホテルごとに予約数、顧客数の集計を行う練習です。 ホテルごとにデータを分ける処理は、groupby関数で実施します。</p> <p>groupby関数は、<code>groupby&#40;df::AbstractDataFrame,cols;kwargs...&#41;</code> のようにデータフレームと列名を引数して、返り値は<code>GroupedDataFrame</code>となります。</p> <p>グループ化したデータ毎に集計する処理はcombine関数で実施します。 combine関数は、<code>GroupedDataFrame</code>を引数にして、さらに <code>列名 &#61;&gt; 関数 &#40;&#61;&gt; 新しい列名&#41;</code>のような書き方の可変長引数をとることができます。</p> <p>この問題は、@chainマクロを用いたパイプライン処理によって、以下のように、簡潔に記述できます。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Chain
df3_1= <span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span>
  groupby(:hotel_id)
  combine(:reserve_id  =&gt; length        =&gt; :rsv_cnt,
          :customer_id =&gt; length∘unique =&gt; :cus_cnt)
<span class=hljs-keyword >end</span>
first(df3_1) |&gt; println</code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <p>予約数は、length関数で集計可能です。 顧客数を集計するには、顧客名の重複を消すために、unique関数とlength関数を合成した関数を利用しました。</p> <p>unique関数とlength関数を組み合わせる書き方は前処理大全では推奨されていない書き方ですが、 この例では可読性が十分高く、処理速度もおそらく問題にならないでしょうからAwesomeということにします。</p> <h3 id="3-2_合計値の算出"><a href="#3-2_合計値の算出" class=header-anchor >3-2 合計値の算出</a></h3> <p>ホテルと宿泊人数毎に集計してみます。複数の列についてグループ分けして集計を行う場合は、<code>:hote_id</code>と<code>:people_num</code>をArrayとして、 groupby関数の引数にすればOKです。 また、グループごとに列の合計値を出力するには、sum関数を指定すればよいです。</p> <pre><code class="julia hljs">df3_2 = <span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span>
  groupby([:hotel_id,:people_num])
  combine(:total_price=&gt; sum =&gt;:price_sum)
<span class=hljs-keyword >end</span>
first(df3_2) |&gt; println</code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <h3 id="3-3_極値代表値の算出"><a href="#3-3_極値代表値の算出" class=header-anchor >3-3 極値、代表値の算出</a></h3> <p>ホテル毎にtotal_price列の最大値、最小値、平均値、中央値、20&#37;のパーセンタイルを出力します。 平均値、中央値、パーセンタイルの出力には、新たな関数が必要なので、Statistics.jlを導入します。 パーセンタイルは、無名関数を使用するため、やや冗長な書き方となっています。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Statistics
<span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span>
  groupby(:hotel_id)
  combine(:total_price=&gt;maximum=&gt;:price_max,
          :total_price=&gt;minimum=&gt;:price_min,
          :total_price=&gt;mean=&gt;:price_mean, 
          :total_price=&gt;median=&gt;:price_medeian,
          :total_price=&gt;(r-&gt;quantile(r,<span class=hljs-number >0.2</span>))=&gt;:price_20per) 
  first(<span class=hljs-number >10</span>)
  println
<span class=hljs-keyword >end</span></code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <h3 id="3-4_ばらつき具合の算出"><a href="#3-4_ばらつき具合の算出" class=header-anchor >3-4 ばらつき具合の算出</a></h3> <p>分散や標準偏差は、平均同様にStatistics.jlをusingすれば使えます。 分散や標準偏差は、データ数が1つしかない場合にはNaN（Not a Number）を返します。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Statistics
<span class=hljs-meta >@show</span> var([<span class=hljs-number >1</span>,<span class=hljs-number >5</span>,<span class=hljs-number >9</span>])
<span class=hljs-meta >@show</span> std([<span class=hljs-number >1</span>,<span class=hljs-number >5</span>,<span class=hljs-number >9</span>])
<span class=hljs-meta >@show</span> var([<span class=hljs-number >1</span>])
<span class=hljs-meta >@show</span> std([<span class=hljs-number >1</span>])</code></pre> <div class=code-output ><pre><code class="plaintext hljs">var([1, 5, 9]) = 16.0
std([1, 5, 9]) = 4.0
var([1]) = NaN
std([1]) = NaN
</code></pre></div> <p>varとstdについてNaNを0に変更する方法を調査しました。いくつか方法はありましたが、 <code>ifelse&#40;isnan&#40;x&#41;,0,x&#41;</code>という関数を使うのが一番短く書けそうです。 &#40;R版の回答にあるcoalesce関数はjuliaにもありますが、機能が異なるようです。&#41;</p> <p>NaNを0に置き換える処理はパイプライン処理の中で無名関数を使って実装することもできますが、 可読性は低いので、ブロードキャスト演算で最後にまとめて処理するのがAwesomeでしょう。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Chain,Statistics,DataFrames
df3_4=<span class=hljs-meta >@chain</span> DataFrame(a=[<span class=hljs-string >&quot;あ&quot;</span>,<span class=hljs-string >&quot;あ&quot;</span>,<span class=hljs-string >&quot;い&quot;</span>],b=[<span class=hljs-number >1</span>,<span class=hljs-number >2</span>,<span class=hljs-number >3</span>]) <span class=hljs-keyword >begin</span>
  groupby(:a)
  combine(:b=&gt;sum,
          :b=&gt;(r-&gt;ifelse(isnan(var(r)),<span class=hljs-number >0</span>,var(r))) =&gt;:b_var,
          :b=&gt;std)
<span class=hljs-keyword >end</span>
<span class=hljs-meta >@show</span> df3_4
df = df3_4[!,<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>] <span class=hljs-comment >#２列目以降のviewを作成。１列目にisnanを適用するとエラーがかえって来ます。</span>
df .= ifelse.(isnan.(df),<span class=hljs-number >0</span>,df) <span class=hljs-comment >#ブロードキャスト演算</span>
println()
<span class=hljs-meta >@show</span> df3_4</code></pre> <div class=code-output ><pre><code class="plaintext hljs">df3_4 = 2×4 DataFrame
 Row │ a       b_sum  b_var    b_std
     │ String  Int64  Float64  Float64
─────┼────────────────────────────────────
   1 │ あ          3      0.5    0.707107
   2 │ い          3      0.0  NaN

df3_4 = 2×4 DataFrame
 Row │ a       b_sum  b_var    b_std
     │ String  Int64  Float64  Float64
─────┼──────────────────────────────────
   1 │ あ          3      0.5  0.707107
   2 │ い          3      0.0  0.0
</code></pre></div> <p>この方法を例題に適用すると以下のようになります。</p> <pre><code class="julia hljs">df3_4=<span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span> 
  groupby(:hotel_id)
  combine(:total_price=&gt;var,
          :total_price=&gt;std)
<span class=hljs-keyword >end</span>
df = df3_4[!,<span class=hljs-number >2</span>:<span class=hljs-keyword >end</span>] <span class=hljs-comment >#２列目以降のviewを作成。１列目にisnanを適用するとエラーがかえって来ます。</span>
df .= ifelse.(isnan.(df),<span class=hljs-number >0</span>,df) <span class=hljs-comment >#ブロードキャスト演算</span>
<span class=hljs-meta >@show</span> first(df3_4,<span class=hljs-number >10</span>)</code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <div class=note ><div class=title >😲 Note</div> <div class=content >前処理大全の著者によれば、データはパートナーの心と同様に不安定でばらつきがあるものだそうです。 分散値/標準偏差値とパートナーの気持ちを常々気にかけたいと思います。</div></div> <h3 id="3-5_最頻値の算出"><a href="#3-5_最頻値の算出" class=header-anchor >3-5 最頻値の算出</a></h3> <p><code>:total_price</code>を100の位を四捨五入して、最頻値を求めます。 四捨五入はround関数で実行できますが、丸める桁はキーワード引数digitsで指定する必要があります。 StatsBase.jlをインポートしておけば、pythonと同じくmode関数で最頻値を求めることが可能です。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> StatsBase
mode(round.(reserve_df.total_price, digits=-<span class=hljs-number >3</span>)) |&gt; println</code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <p>2万円くらいホテルにお金を落としている人が一番多いということですね。</p> <h3 id="3-6_順位の算出"><a href="#3-6_順位の算出" class=header-anchor >3-6 順位の算出</a></h3> <p>ホテルごとに予約日時順の番号付けをしてみます。 そもそも予約日時がString型として認識されているので、まずはDateTime型にパースします。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Dates
reserve_df.reserve_datetime = DateTime.(reserve_df.reserve_datetime,<span class=hljs-string >dateformat&quot;y-m-d HH:MM:SS&quot;</span>)
reserve_df |&gt; first |&gt; println</code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <p>ランキング付けに対応する関数はStatsBase.jlに用意されています。</p> <table><tr><th align=right >関数名<th align=right >表示法<tr><td align=right >ordinalrank<td align=right >1234<tr><td align=right >competerank<td align=right >1223<tr><td align=right >denserank<td align=right >1223<tr><td align=right >tiedrank<td align=right >1 2.5 2.5 4</table> <p>ランキング方法にもいくつか種類がありますが、日時が完全に一致することはないでしょうから、 ここでは<code>ordinalrank</code>を利用します。</p> <p>前処理の手順としては、groupby関数でhotel_id毎にデータを分けて、select関数で必要な列を選びます。</p> <p>select関数の引数は<code>:列名 &#61;&gt; 処理 &#61;&gt; :新しい列名</code>というようにcombine関数と同じような与え方が可能です。 ではやってみます。</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> StatsBase
<span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span>
  groupby(:hotel_id)
  select(:,:reserve_datetime =&gt; ordinalrank =&gt;:log_no)
  first(<span class=hljs-number >10</span>)
  println
<span class=hljs-keyword >end</span></code></pre> <p><div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> 一番右の列に<code>:log_no</code>の列が追加されていることが確認できます。</p> <h3 id="q_ランキング"><a href="#q_ランキング" class=header-anchor >Q ランキング</a></h3> <p>ホテル毎に予約数を集計して、ランキング付けを行います。同じ予約数の場合は、 最小の順位を付けることになっているので、ordinalrankではなくて、competerankを利用します。</p> <pre><code class="julia hljs"><span class=hljs-meta >@chain</span> reserve_df <span class=hljs-keyword >begin</span>
  groupby(:hotel_id)
  combine(:reserve_id =&gt; length =&gt; :rsv_cnt)
  select(:,:rsv_cnt =&gt; competerank =&gt;:rsv_cnt_rank)
  first(<span class=hljs-number >10</span>)
  println
<span class=hljs-keyword >end</span></code></pre> <div class=code-output ><pre><code class="plaintext hljs">UndefVarError: reserve_df not defined
</code></pre></div> <p> <div class=prev-next-link > <a class=prev-link  href=" /tips/preprocess1"> <p class=prev-next-label >前の記事</p> <p> Awesome な前処理1 </p> </a> <a class=next-link  href=" /tips/preprocess3"> <p class=prev-next-label >次の記事</p> <p> Awesome な前処理3 </p> </a> </div> <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p> <div class=page-foot > <div class=copyright > &copy; Kei Hanafusa. Last modified: March 05, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> <div class=page__footer > <footer> <div class=page__footer-follow > <ul class=social-icons > <li><strong>Follow:</strong> <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden=true ></i> Twitter</a> <li><a href="https://github.com/lethal8723" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i> GitHub</a> </ul> </div> <div class=page__footer-copyright >&copy; Kei Hanafusa. Powered by <a href="https://github.com/tlienart/Franklin.jl">Franklin</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel=nofollow >Minimal Mistakes</a>.</div> </footer> </div> <script src="/libs/minimal-mistakes/main.min.js"></script> <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin=anonymous ></script> <script src="/libs/myBtn/myBtn.js"></script> <script src="/libs/luminous/Luminous.min.js"></script> <script> new Luminous(document.querySelectorAll('.zoom')); </script> <script> function myToc() { var x = document.getElementsByClassName("mytoc"); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script>