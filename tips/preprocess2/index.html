<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.4 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <link rel="stylesheet" href="/libs/highlight/github.min.css">
   
  <link rel="stylesheet" href="/css/franklin.css">
<link rel="stylesheet" href="/css/minimal-mistakes.css">
<link rel="stylesheet" href="/css/adjust.css">
<link rel="stylesheet" href="/css/luminous-basic.min.css">
<link rel="icon" href="/assets/favicon.ico">
<link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->

<!--[if IE ]>
<style>
  /* old IE unsupported flexbox fixes */
  .greedy-nav .site-title {
    padding-right: 3em;
  }
  .greedy-nav button {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
  }
</style>
<![endif]-->

   <title>Awesome な前処理</title>  
  <!-- end custom head snippets -->
</head>
<body class="layout--single">
  <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Hanafsky.com</a>
        <ul class="visible-links">
          <li class="masthead__menu-item"><a href="/tips/" >Julia-tips</a></li>
          <li class="masthead__menu-item"><a href="/blog/" >Blog</a></li>
          <li class="masthead__menu-item"><a href="/project/" >Projects</a></li>
          <li class="masthead__menu-item"><a href="/about/">About</a></li>
        </ul>
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

  <div class="initial-content">
    <div id="main" role="main">
      <div class="sidebar sticky">
        <div itemscope itemtype="https://schema.org/Person">
          <div class="author__avatar">
            <img src="/assets/design/author3.png" alt="Dio" itemprop="image">
          </div>
          <div class="author__content">
            <h3 class="author__name" itemprop="name">Kei Hanafusa</h3>
            <p class="author__bio" itemprop="description">Chemical Engineer, <br> living in Osaka, 🗾</p>
          </div>
          <div class="author__urls-wrapper">
            <button class="btn btn--inverse">Follow</button>
            <ul class="author__urls social-icons">
              <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
                <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Osaka, Japan</span></li>
              <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
              <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
            </ul>
          </div>

          
          
              

          <div class="author__urls-wrapper">
            <button class="btn btn--inverse">Tag</button>
            <ul class="author__urls social-icons">
              <li>タグ</li>
              <li></li>
              <li><a href="/tag/setting/">設定</a></li>
              <li><a href="/tag/thirdparty/">サードパーティライブラリ</a></li>
              <li><a href="/tag/recipe">レシピ</a></li>
            </ul>
          </div>
          
        </div>
      </div>


<!-- Content appended here -->
<div class="franklin-content"><h1 id="awesome_な前処理_2"><a href="#awesome_な前処理_2" class="header-anchor">Awesome な前処理 2</a></h1>
<p>前処理大全のjulia版その2です。 まずは、ホテルの予約データを読み込みます。</p>
<pre><code class="language-julia">using DataFrames,CSV
path &#61; joinpath&#40;&quot;tips&quot;,&quot;data&quot;,&quot;reserve.csv&quot;&#41;
reserve_df &#61; CSV.read&#40;path,DataFrame&#41;
#first&#40;reserve_df&#41; |&gt; println</code></pre>
<div class="code-output"></div>
<div class="franklin-toc"><ol><li><a href="#3_集約">3 集約</a><ol><li><a href="#3-1_データ数種類数の算出">3-1 データ数、種類数の算出</a></li><li><a href="#3-2_合計値の算出">3-2 合計値の算出</a></li><li><a href="#3-3_極値代表値の算出">3-3 極値、代表値の算出</a></li><li><a href="#3-4_ばらつき具合の算出">3-4 ばらつき具合の算出</a></li><li><a href="#3-5_最頻値の算出">3-5 最頻値の算出</a></li><li><a href="#3-6_順位の算出">3-6 順位の算出</a></li><li><a href="#q_ランキング">Q ランキング</a></li></ol></li></ol></div>
<h2 id="3_集約"><a href="#3_集約" class="header-anchor">3 集約</a></h2>
<h3 id="3-1_データ数種類数の算出"><a href="#3-1_データ数種類数の算出" class="header-anchor">3-1 データ数、種類数の算出</a></h3>
<p>ホテルごとに予約数、顧客数の集計を行う練習です。 ホテルごとにデータを分ける処理は、groupby関数で実施します。</p>
<p>groupby関数は、<code>groupby&#40;df::AbstractDataFrame,cols;kwargs...&#41;</code> のようにデータフレームと列名を引数して、返り値は<code>GroupedDataFrame</code>となります。</p>
<p>グループ化したデータ毎に集計する処理はcombine関数で実施します。 combine関数は、<code>GroupedDataFrame</code>を引数にして、さらに <code>列名 &#61;&gt; 関数 &#40;&#61;&gt; 新しい列名&#41;</code>のような書き方の可変長引数をとることができます。</p>
<p>この問題は、@chainマクロを用いたパイプライン処理によって、以下のように、簡潔に記述できます。</p>
<pre><code class="language-julia">using Chain
df3_1&#61; @chain reserve_df begin
  groupby&#40;:hotel_id&#41;
  combine&#40;:reserve_id  &#61;&gt; length        &#61;&gt; :rsv_cnt,
          :customer_id &#61;&gt; length∘unique &#61;&gt; :cus_cnt&#41;
end
first&#40;df3_1&#41; |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext">DataFrameRow
 Row │ hotel_id  rsv_cnt  cus_cnt
     │ String    Int64    Int64
─────┼────────────────────────────
   1 │ h_75           12       12
</code></pre></div>
<p>予約数は、length関数で集計可能です。 顧客数を集計するには、顧客名の重複を消すために、unique関数とlength関数を合成した関数を利用しました。</p>
<p>unique関数とlength関数を組み合わせる書き方は前処理大全では推奨されていない書き方ですが、 この例では可読性が十分高く、処理速度もおそらく問題にならないでしょうからAwesomeということにします。</p>
<h3 id="3-2_合計値の算出"><a href="#3-2_合計値の算出" class="header-anchor">3-2 合計値の算出</a></h3>
<p>ホテルと宿泊人数毎に集計してみます。複数の列についてグループ分けして集計を行う場合は、<code>:hote_id</code>と<code>:people_num</code>をArrayとして、 groupby関数の引数にすればOKです。 また、グループごとに列の合計値を出力するには、sum関数を指定すればよいです。</p>
<pre><code class="language-julia">df3_2 &#61; @chain reserve_df begin
  groupby&#40;&#91;:hotel_id,:people_num&#93;&#41;
  combine&#40;:total_price&#61;&gt; sum &#61;&gt;:price_sum&#41;
end
first&#40;df3_2&#41; |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext">DataFrameRow
 Row │ hotel_id  people_num  price_sum
     │ String    Int64       Int64
─────┼─────────────────────────────────
   1 │ h_75               4     421200
</code></pre></div>
<h3 id="3-3_極値代表値の算出"><a href="#3-3_極値代表値の算出" class="header-anchor">3-3 極値、代表値の算出</a></h3>
<p>ホテル毎にtotal_price列の最大値、最小値、平均値、中央値、20&#37;のパーセンタイルを出力します。 平均値、中央値、パーセンタイルの出力には、新たな関数が必要なので、Statistics.jlを導入します。 パーセンタイルは、無名関数を使用するため、やや冗長な書き方となっています。</p>
<pre><code class="language-julia">using Statistics
@chain reserve_df begin
  groupby&#40;:hotel_id&#41;
  combine&#40;:total_price&#61;&gt;maximum&#61;&gt;:price_max,
          :total_price&#61;&gt;minimum&#61;&gt;:price_min,
          :total_price&#61;&gt;mean&#61;&gt;:price_mean, 
          :total_price&#61;&gt;median&#61;&gt;:price_medeian,
          :total_price&#61;&gt;&#40;r-&gt;quantile&#40;r,0.2&#41;&#41;&#61;&gt;:price_20per&#41; 
  first&#40;10&#41;
  println
end</code></pre>
<div class="code-output"><pre><code class="plaintext">10×6 DataFrame
 Row │ hotel_id  price_max  price_min  price_mean      price_medeian  price_20per
     │ String    Int64      Int64      Float64         Float64        Float64
─────┼────────────────────────────────────────────────────────────────────────────
   1 │ h_75          97200      16200   49950.0              36450.0      24300.0
   2 │ h_219         92700      10300   46746.2              30900.0      20600.0
   3 │ h_179         67200       5600   32421.1              33600.0      17920.0
   4 │ h_214        437400     145800       2.51836e5       291600.0     194400.0
   5 │ h_16         272400      45400       1.42174e5       136200.0      68100.0
   6 │ h_241         72000       6000   29555.6              24000.0      12000.0
   7 │ h_256        414000      34500       1.53682e5       103500.0      69000.0
   8 │ h_217        136800      22800   78763.6              68400.0      45600.0
   9 │ h_240        320400      26700  137060.0              80100.0      48060.0
  10 │ h_183        118800       9900   48400.0              39600.0      29700.0
</code></pre></div>
<h3 id="3-4_ばらつき具合の算出"><a href="#3-4_ばらつき具合の算出" class="header-anchor">3-4 ばらつき具合の算出</a></h3>
<p>分散や標準偏差は、平均同様にStatistics.jlをusingすれば使えます。 分散や標準偏差は、データ数が1つしかない場合にはNaN（Not a Number）を返します。</p>
<pre><code class="language-julia">using Statistics
@show var&#40;&#91;1,5,9&#93;&#41;
@show std&#40;&#91;1,5,9&#93;&#41;
@show var&#40;&#91;1&#93;&#41;
@show std&#40;&#91;1&#93;&#41;</code></pre>
<div class="code-output"><pre><code class="plaintext">var([1, 5, 9]) = 16.0
std([1, 5, 9]) = 4.0
var([1]) = NaN
std([1]) = NaN
</code></pre></div>
<p>varとstdについてNaNを0に変更する方法を調査しました。いくつか方法はありましたが、 <code>ifelse&#40;isnan&#40;x&#41;,0,x&#41;</code>という関数を使うのが一番短く書けそうです。 &#40;R版の回答にあるcoalesce関数はjuliaにもありますが、機能が異なるようです。&#41;</p>
<p>NaNを0に置き換える処理はパイプライン処理の中で無名関数を使って実装することもできますが、 可読性は低いので、ブロードキャスト演算で最後にまとめて処理するのがAwesomeでしょう。</p>
<pre><code class="language-julia">using Chain,Statistics,DataFrames
df3_4&#61;@chain DataFrame&#40;a&#61;&#91;&quot;あ&quot;,&quot;あ&quot;,&quot;い&quot;&#93;,b&#61;&#91;1,2,3&#93;&#41; begin
  groupby&#40;:a&#41;
  combine&#40;:b&#61;&gt;sum,
          :b&#61;&gt;&#40;r-&gt;ifelse&#40;isnan&#40;var&#40;r&#41;&#41;,0,var&#40;r&#41;&#41;&#41; &#61;&gt;:b_var,
          :b&#61;&gt;std&#41;
end
@show df3_4
df &#61; df3_4&#91;&#33;,2:end&#93; #２列目以降のviewを作成。１列目にisnanを適用するとエラーがかえって来ます。
df .&#61; ifelse.&#40;isnan.&#40;df&#41;,0,df&#41; #ブロードキャスト演算
println&#40;&#41;
@show df3_4</code></pre>
<div class="code-output"><pre><code class="plaintext">df3_4 = 2×4 DataFrame
 Row │ a       b_sum  b_var    b_std
     │ String  Int64  Float64  Float64
─────┼────────────────────────────────────
   1 │ あ          3      0.5    0.707107
   2 │ い          3      0.0  NaN

df3_4 = 2×4 DataFrame
 Row │ a       b_sum  b_var    b_std
     │ String  Int64  Float64  Float64
─────┼──────────────────────────────────
   1 │ あ          3      0.5  0.707107
   2 │ い          3      0.0  0.0
</code></pre></div>
<p>この方法を例題に適用すると以下のようになります。</p>
<pre><code class="language-julia">df3_4&#61;@chain reserve_df begin 
  groupby&#40;:hotel_id&#41;
  combine&#40;:total_price&#61;&gt;var,
          :total_price&#61;&gt;std&#41;
end
df &#61; df3_4&#91;&#33;,2:end&#93; #２列目以降のviewを作成。１列目にisnanを適用するとエラーがかえって来ます。
df .&#61; ifelse.&#40;isnan.&#40;df&#41;,0,df&#41; #ブロードキャスト演算
@show first&#40;df3_4,10&#41;</code></pre>
<div class="code-output"><pre><code class="plaintext">first(df3_4, 10) = 10×3 DataFrame
 Row │ hotel_id  total_price_var  total_price_std
     │ String    Float64          Float64
─────┼────────────────────────────────────────────
   1 │ h_75           1.09549e9     33098.2
   2 │ h_219          8.59601e8     29319.0
   3 │ h_179          3.08648e8     17568.4
   4 │ h_214          7.47238e9     86442.9
   5 │ h_16           6.57522e9     81087.7
   6 │ h_241          4.53949e8     21306.1
   7 │ h_256          1.77023e10        1.3305e5
   8 │ h_217          1.46737e9     38306.2
   9 │ h_240          1.16982e10        1.08158e5
  10 │ h_183          7.94329e8     28183.9
</code></pre></div>
<div class="note"><div class="title">😲 Note</div>
<div class="content">前処理大全の著者によれば、データはパートナーの心と同様に不安定でばらつきがあるものだそうです。 分散値/標準偏差値とパートナーの気持ちを常々気にかけたいと思います。</div></div>
<h3 id="3-5_最頻値の算出"><a href="#3-5_最頻値の算出" class="header-anchor">3-5 最頻値の算出</a></h3>
<p><code>:total_price</code>を100の位を四捨五入して、最頻値を求めます。 四捨五入はround関数で実行できますが、丸める桁はキーワード引数digitsで指定する必要があります。 StatsBase.jlをインポートしておけば、pythonと同じくmode関数で最頻値を求めることが可能です。</p>
<pre><code class="language-julia">using StatsBase
mode&#40;round.&#40;reserve_df.total_price, digits&#61;-3&#41;&#41; |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext">20000.0
</code></pre></div>
<p>2万円くらいホテルにお金を落としている人が一番多いということですね。</p>
<h3 id="3-6_順位の算出"><a href="#3-6_順位の算出" class="header-anchor">3-6 順位の算出</a></h3>
<p>ホテルごとに予約日時順の番号付けをしてみます。 そもそも予約日時がString型として認識されているので、まずはDateTime型にパースします。</p>
<pre><code class="language-julia">using Dates
reserve_df.reserve_datetime &#61; DateTime.&#40;reserve_df.reserve_datetime,dateformat&quot;y-m-d HH:MM:SS&quot;&#41;
reserve_df |&gt; first |&gt; println</code></pre>
<div class="code-output"><pre><code class="plaintext">DataFrameRow
 Row │ reserve_id  hotel_id  customer_id  reserve_datetime     checkin_date  checkin_time  checkout_date  people_num  total_price
     │ String      String    String       Dates.DateTime       Dates.Date    Dates.Time    Dates.Date     Int64       Int64
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ r1          h_75      c_1          2016-03-06T13:09:42  2016-03-26    10:00:00      2016-03-29              4        97200
</code></pre></div>
<p>ランキング付けに対応する関数はStatsBase.jlに用意されています。</p>
<table><tr><th align="right">関数名</th><th align="right">表示法</th></tr><tr><td align="right">ordinalrank</td><td align="right">1234</td></tr><tr><td align="right">competerank</td><td align="right">1223</td></tr><tr><td align="right">denserank</td><td align="right">1223</td></tr><tr><td align="right">tiedrank</td><td align="right">1 2.5 2.5 4</td></tr></table>
<p>ランキング方法にもいくつか種類がありますが、日時が完全に一致することはないでしょうから、 ここでは<code>ordinalrank</code>を利用します。</p>
<p>前処理の手順としては、groupby関数でhotel_id毎にデータを分けて、select関数で必要な列を選びます。</p>
<p>select関数の引数は<code>:列名 &#61;&gt; 処理 &#61;&gt; :新しい列名</code>というようにcombine関数と同じような与え方が可能です。 ではやってみます。</p>
<pre><code class="language-julia">using StatsBase
@chain reserve_df begin
  groupby&#40;:hotel_id&#41;
  select&#40;:,:reserve_datetime &#61;&gt; ordinalrank &#61;&gt;:log_no&#41;
  first&#40;10&#41;
  println
end</code></pre>
<p><div class="code-output"><pre><code class="plaintext">10×10 DataFrame
 Row │ hotel_id  reserve_id  customer_id  reserve_datetime     checkin_date  checkin_time  checkout_date  people_num  total_price  log_no
     │ String    String      String       Dates.DateTime       Dates.Date    Dates.Time    Dates.Date     Int64       Int64        Int64
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ h_75      r1          c_1          2016-03-06T13:09:42  2016-03-26    10:00:00      2016-03-29              4        97200       3
   2 │ h_219     r2          c_1          2016-07-16T23:39:55  2016-07-20    11:30:00      2016-07-21              2        20600       4
   3 │ h_179     r3          c_1          2016-09-24T10:03:17  2016-10-19    09:00:00      2016-10-22              2        33600      12
   4 │ h_214     r4          c_1          2017-03-08T03:20:10  2017-03-29    11:00:00      2017-03-30              4       194400       9
   5 │ h_16      r5          c_1          2017-09-05T19:50:37  2017-09-22    10:30:00      2017-09-23              3        68100      18
   6 │ h_241     r6          c_1          2017-11-27T18:47:05  2017-12-04    12:00:00      2017-12-06              3        36000      25
   7 │ h_256     r7          c_1          2017-12-29T10:38:36  2018-01-25    10:30:00      2018-01-28              1       103500      11
   8 │ h_241     r8          c_1          2018-05-26T08:42:51  2018-06-08    10:00:00      2018-06-09              1         6000      26
   9 │ h_217     r9          c_2          2016-03-05T13:31:06  2016-03-25    09:30:00      2016-03-27              3        68400       2
  10 │ h_240     r10         c_2          2016-06-25T09:12:22  2016-07-14    11:00:00      2016-07-17              4       320400       4
</code></pre></div> 一番右の列に<code>:log_no</code>の列が追加されていることが確認できます。</p>
<h3 id="q_ランキング"><a href="#q_ランキング" class="header-anchor">Q ランキング</a></h3>
<p>ホテル毎に予約数を集計して、ランキング付けを行います。同じ予約数の場合は、 最小の順位を付けることになっているので、ordinalrankではなくて、competerankを利用します。</p>
<pre><code class="language-julia">@chain reserve_df begin
  groupby&#40;:hotel_id&#41;
  combine&#40;:reserve_id &#61;&gt; length &#61;&gt; :rsv_cnt&#41;
  select&#40;:,:rsv_cnt &#61;&gt; competerank &#61;&gt;:rsv_cnt_rank&#41;
  first&#40;10&#41;
  println
end</code></pre>
<div class="code-output"><pre><code class="plaintext">10×3 DataFrame
 Row │ hotel_id  rsv_cnt  rsv_cnt_rank
     │ String    Int64    Int64
─────┼─────────────────────────────────
   1 │ h_75           12           100
   2 │ h_219          13           127
   3 │ h_179          19           270
   4 │ h_214          11            67
   5 │ h_16           19           270
   6 │ h_241          27           300
   7 │ h_256          11            67
   8 │ h_217          11            67
   9 │ h_240          15           187
  10 │ h_183          18           259
</code></pre></div>
<p>
  <div class="prev-next-link">
  <a class="prev-link" href="https://hanafsky.com//tips/preprocess1">
    <p class="prev-next-label">前の記事</p>
    <p>
       Awesome な前処理1
    </p>
  </a>
  <a class="next-link" href="https://hanafsky.com//tips/preprocess3">
    <p class="prev-next-label">次の記事</p>
    <p>
       Awesome な前処理3
    </p>
  </a>
</div>
  <button onclick="topFunction()" id="myBtn" title="Go to top">Top</button> </p>
<div class="page-foot">
  <div class="copyright">
    &copy; Kei Hanafusa. Last modified: April 04, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div><!-- CONTENT ENDS HERE -->

      </div> <!-- closure of main -->
    </div>   <!-- closure of class initial--content -->

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
        <!-- end custom footer snippets -->
        <div class="page__footer-follow">
          <ul class="social-icons">
            <li><strong>Follow:</strong></li>
            <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
            <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
          </ul>
        </div>
        <div class="page__footer-copyright">&copy; Kei Hanafusa. Powered by <a href="https://github.com/tlienart/Franklin.jl">Franklin</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    <script src="/libs/minimal-mistakes/main.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin="anonymous"></script>
    <script src="/libs/myBtn/myBtn.js"></script>
    <script src="/libs/luminous/Luminous.min.js"></script>

    
    
        <script src="/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>

    
    
    <script>
    new Luminous(document.querySelectorAll('.zoom'));
</script>
    <script>
function myToc() {
    var x = document.getElementsByClassName("mytoc");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }
  } 
</script>
  </body>
</html>
