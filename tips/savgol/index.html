<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.16.4 by Michael Rose Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE --> <html lang=ja > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/minimal-mistakes.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="/css/luminous-basic.min.css"> <link rel=icon  href="/assets/favicon.ico"> <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel=stylesheet > <!--[if IE ]> <style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; } </style> <![endif]--> <title>ノイズを含むデータの微分</title> <body class=layout--single > <div class=masthead > <div class=masthead__inner-wrap > <div class=masthead__menu > <nav id=site-nav  class=greedy-nav > <a class=site-title  href="/">Hanafsky.com</a> <ul class=visible-links > <li class=masthead__menu-item ><a href="/tips/" >Julia-tips</a> <li class=masthead__menu-item ><a href="/blog/" >Blog</a> <li class=masthead__menu-item ><a href="/project/" >Projects</a> <li class=masthead__menu-item ><a href="/about/">About</a> </ul> <button class="greedy-nav__toggle hidden" type=button > <span class=visually-hidden >Toggle menu</span> <div class=navicon ></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class=initial-content > <div id=main  role=main > <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class=author__avatar > <img src="/assets/design/author3.png" alt=Dio  itemprop=image > </div> <div class=author__content > <h3 class=author__name  itemprop=name >Kei Hanafusa</h3> <p class=author__bio  itemprop=description >Chemical Engineer, <br> living in Osaka, 🗾</p> </div> <div class=author__urls-wrapper > <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop=homeLocation  itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden=true ></i> <span itemprop=name >Osaka, Japan</span> <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden=true ></i> Twitter</a> <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i> GitHub</a> </ul> </div> <div class=author__urls-wrapper > <button class="btn btn--inverse">Tag</button> <ul class="author__urls social-icons"> <li>タグ <li> <li><a href="/tag/setting/">設定</a> <li><a href="/tag/thirdparty/">サードパーティライブラリ</a> <li><a href="/tag/recipe">レシピ</a> </ul> </div> </div> </div> <div class=franklin-content ><h1 id="ノイズを含むデータの微分_-_savitzky-golay_filter"><a href="#ノイズを含むデータの微分_-_savitzky-golay_filter" class=header-anchor >ノイズを含むデータの微分 - Savitzky-Golay filter</a></h1> <p> <div style="text-align:center"> <img src="/assets/tips/smooth-3221868_640.jpg" alt="" height=200px > </div> <div class="sns-container top"> <div class="sns-box b-twitter"> <a href="https://twitter.com/share?url=https://hanafsky.com/tips/savgol/&text=ノイズを含むデータの微分 - Savitzky-Golay filter&via=HanafusaKei&related=HanafusaKei" target=_blank  rel=nofollow ><i class="fab fa-twitter"></i></a></div> <div class="sns-box b-facebook"> <a href="http://www.facebook.com/share.php?u=https://hanafsky.com/tips/savgol/" target=_blank  rel=nofollow ><i class="fab fa-facebook"></i></a></div> <div class="sns-box b-hatena"> <a href="http://b.hatena.ne.jp/add?mode=confirm&url=http://hanafsky.com/tips/savgol/&title=ノイズを含むデータの微分 - Savitzky-Golay filter" target=_blank  rel=nofollow ><span class=icon-hatena ></span></a></div> <div class="sns-box b-pocket"> <a href="http://getpocket.com/edit?url=https://hanafsky.com/tips/savgol/&title=ノイズを含むデータの微分 - Savitzky-Golay filter" rel=nofollow  target=_blank ><i class="fab fa-get-pocket"></i></a></div> <div class="sns-box b-feedly"> <a href='https://feedly.com/i/subscription/feed/https://hanafsky.com/tips/savgol/' target='blank' rel=nofollow ><span class=icon-feedly ></span></a></div> <div class="sns-box b-line"> <a href='https://social-plugins.line.me/lineit/share?url=https://hanafsky.com/tips/savgol/' target='blank' rel=nofollow ><span class=icon-line ></span></a></div> </div> </p> <p>実験データを解析するときに、傾きや変曲点を求めたくなる時があります。 典型的なのが、時系列データの解析をしているときに、データが急激に変化し 始めるポイントを特定したいときです。 学生の頃は、scipyで実装されたsavitzky-golayフィルターをよく使っていたのですが、 juliaでは公式パッケージで使えるものはなさそうです。<sup id="fnref:1"><a href="#fndef:1" class=fnref >[1]</a></sup></p> <p>scipyをimportしても良いのですが、 <a href="https://pixorblog.wordpress.com/2016/07/13/savitzky-golay-filters-julia/">Vincent-Picaudさんがblogで公開している説明</a>がとても分かりやすいので、 それに参考にして日本語で原理をまとめたり、juliaでの実装をまとめたいと思います。</p> <div class=footnote  id=footnote-1 ><p class=footnote-title >1</p><p>VincentさんのDirectConvolution.jlで実行可能のはずなのですが、3年ほどメンテされていなくて、現在は使用不可となっています。</p> </div> <div class=franklin-toc ><ol><li><a href="#savitzkyとgolayの心">SavitzkyとGolayの心</a><li><a href="#相互相関関数">相互相関関数</a></ol></div> <h2 id="savitzkyとgolayの心"><a href="#savitzkyとgolayの心" class=header-anchor >SavitzkyとGolayの心</a></h2> <p>一言で結論をまとめると「ある点におけるn階微分係数をテーラー展開と多項式近似から推定する」ということになります。</p> <p>\((\bm{x},\bm{y}) = [(x_1,y_1), \dots, (x_N,y_N)] (x,y\in\mathbb R, N\in \N)\)のデータセットがあった時のことを考えます。</p> <p>多項式\(P(x)\)の\(x = x_k(k\in{1,\dots N})\)におけるd階微分係数を\(p^{(d)}(x_k)\)と書くことにすると、\(x=x_k\)周りのd次のテーラー展開は次のように書けます。</p> \[P(x) = \sum_{j=0}^{d}\dfrac{(x-x_k)^j}{j!}P^{j}(x_k)\] <p>\(x=x_k\)の近くの\(2n+1\)個の点、\(\bm{x}=\{x_{k+i}|i=0, \pm1,\pm2,\dots,\pm n \}\)について、\(P(\bm{x})\)を行列で書くと</p> \[\begin{aligned} P(\bm{x}) &= \begin{bmatrix} \vdots & \vdots & \vdots \\ 1 & \dfrac{(x_i-x_k)^j}{j!} & \dfrac{(x_i-x_k)^d}{d!} \\ \vdots & \vdots & \vdots \end{bmatrix}\cdot \begin{bmatrix} P^{(0)}(x_k) \\ \vdots \\ P^{(j)}(x_k) \\ \vdots \\ P^{(d)}(x_k) \\ \end{bmatrix}\\ &= \begin{bmatrix} \vdots & \vdots & \vdots \\ 1 & (x_i-x_k)^j & (x_i-x_k)^d \\ \vdots & \vdots & \vdots \end{bmatrix}\cdot \begin{bmatrix} 1 & & & & 0 \\ & \ddots & & & \\ & & \dfrac{1}{j!} & & \\ & & & \ddots & \\ 0 & & & &\dfrac{1}{d!} \end{bmatrix}\cdot \begin{bmatrix} P^{(0)}(x_k) \\ \vdots \\ P^{(j)}(x_k) \\ \vdots \\ P^{(d)}(x_k) \\ \end{bmatrix}\\ &= \rm{VD^{-1}P}^{\delta} \end{aligned} \] <p>\(\rm{V}\)はVendermonde行列で、\(\rm{D}\)は \(j! (j=0,1,\dots,d)\) を対角成分にもった対角行列です。 また、\(\rm{P}^{\delta}\)は微分係数の列ベクトルです。</p> <p>一方で、\(\bm{y} = \{y_{k-n}, \dots, y_{k+n} \}\)を\((x-x_k)\)のd次多項式の最小二乗法で回帰分析すると</p> <p>回帰係数の推定値を\(\hat{\beta}\)として</p> \[ \hat{\beta} = (\rm{V}^\mathsf{T}\rm{V})^{-1}\rm{V}^\mathsf{T}\bm{y} \] <p>と書けますから、</p> \[ \begin{aligned} P(\bm{x}) &= \rm{V}\bm{\hat{\beta}} \\ &= \rm{V}(\rm{V}^\mathsf{T}\rm{V})^{-1}\rm{V}^\mathsf{T}\bm{y} \\ &= \rm{VD^{-1}P}^{\delta} \end{aligned} \] <p>となります。 \(\rm{VD^{-1}P}^{\delta} =\rm{V}(\rm{V}^\mathsf{T}\rm{V})^{-1}\rm{V}^\mathsf{T}\bm{y}\)の両辺に\(V^\mathsf{T}\)をかけて整理していけば、</p> \[\rm{P}^{\delta} = \rm{D}(\rm{V}^\mathsf{T}\rm{V})^{-1}\rm{V}^\mathsf{T}\bm{y}\] <p>となって、微分係数を求めることができます。</p> <p>VincentさんはVをQR分解してさらに整理しています。 <div class=note ><div class=title >😲 Note</div> <div class=content >実はjuliaでは連立一次方程式の解法はQR分解を利用しています。 REPLで<code>?\</code>とたたけば分かります。</div></div></p> <h2 id="相互相関関数"><a href="#相互相関関数" class=header-anchor >相互相関関数</a></h2> <p>\(\rm{D}(\rm{V}^\mathsf{T}\rm{V})^{-1}\rm{V}^\mathsf{T}\)は\((1+d) \times (2n+1)\)行列です。\(j\)行\((n+i+1)\)列目の成分を\(f_{j}[n+i+1](i\in \{-n,-n+1,\dots,n\})\)と書くことにすれば、 \(x=x_k\)における\(j\)階微分は</p> \[ P^{(j)}(x_k) = \sum_{i\in(-n,n)} f_{j}[n+i+1]y_{k+i}\] <p>として求められることが分かります。</p> \[ \sum_{m} F(m)G(n+m) \] <p>は自己相関関数と呼ばれるもので、\(G\)のかわりにそれを逆順に並べたものを利用すれば、畳込みになります。</p> \[ \sum_{-m} F(m)G(n-m) \] <p>データ点が等間隔であるならば、どの\(x_k\)についても、同じ\(f\)を適用できるので、 高速フーリエ変換を利用した畳み込み積分を利用できます。</p> <p>畳み込む列が小さい時は、直接畳込みを実行した方が速いそうですが、まずは高速フーリエ変換で実装してみます。 &#40;続く&#41;</p> <p> <div class="sns-container top"> <div class="sns-box b-twitter"> <a href="https://twitter.com/share?url=https://hanafsky.com/tips/savgol/&text=ノイズを含むデータの微分 - Savitzky-Golay filter&via=HanafusaKei&related=HanafusaKei" target=_blank  rel=nofollow ><i class="fab fa-twitter"></i></a></div> <div class="sns-box b-facebook"> <a href="http://www.facebook.com/share.php?u=https://hanafsky.com/tips/savgol/" target=_blank  rel=nofollow ><i class="fab fa-facebook"></i></a></div> <div class="sns-box b-hatena"> <a href="http://b.hatena.ne.jp/add?mode=confirm&url=http://hanafsky.com/tips/savgol/&title=ノイズを含むデータの微分 - Savitzky-Golay filter" target=_blank  rel=nofollow ><span class=icon-hatena ></span></a></div> <div class="sns-box b-pocket"> <a href="http://getpocket.com/edit?url=https://hanafsky.com/tips/savgol/&title=ノイズを含むデータの微分 - Savitzky-Golay filter" rel=nofollow  target=_blank ><i class="fab fa-get-pocket"></i></a></div> <div class="sns-box b-feedly"> <a href='https://feedly.com/i/subscription/feed/https://hanafsky.com/tips/savgol/' target='blank' rel=nofollow ><span class=icon-feedly ></span></a></div> <div class="sns-box b-line"> <a href='https://social-plugins.line.me/lineit/share?url=https://hanafsky.com/tips/savgol/' target='blank' rel=nofollow ><span class=icon-line ></span></a></div> </div> <div class=prev-next-link > <a class=prev-link  href="https://hanafsky.com/tips/pluto"> <p class=prev-next-label >前の記事</p> <p> リアクティブなノートブック Pluto.jl </p> </a> </div> <button onclick="topFunction()" id=myBtn  title="Go to top">Top</button> </p> <div class=page-foot > <div class=copyright > &copy; Kei Hanafusa. Last modified: March 28, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> <div class=page__footer > <footer> <div class=page__footer-follow > <ul class=social-icons > <li><strong>Follow:</strong> <li><a href="https://twitter.com/hanafusakei" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden=true ></i> Twitter</a> <li><a href="https://github.com/hanafsky" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden=true ></i> GitHub</a> </ul> </div> <div class=page__footer-copyright >&copy; Kei Hanafusa. Powered by <a href="https://github.com/tlienart/Franklin.jl">Franklin</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel=nofollow >Minimal Mistakes</a>.</div> </footer> </div> <script src="/libs/minimal-mistakes/main.min.js"></script> <script defer src="https://use.fontawesome.com/releases/v5.8.2/js/all.js" integrity="sha384-DJ25uNYET2XCl5ZF++U8eNxPWqcKohUUBUpKGlNLMchM7q4Wjg2CUpjHLaL8yYPH" crossorigin=anonymous ></script> <script src="/libs/myBtn/myBtn.js"></script> <script src="/libs/luminous/Luminous.min.js"></script> <script src="/libs/katex/katex.min.js"></script> <script src="/libs/katex/auto-render.min.js"></script> <script>renderMathInElement(document.body)</script> <script src="/libs/highlight/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: ' '});</script> <script> new Luminous(document.querySelectorAll('.zoom')); </script> <script> function myToc() { var x = document.getElementsByClassName("mytoc"); if (x.style.display === "none") { x.style.display = "block"; } else { x.style.display = "none"; } } </script>